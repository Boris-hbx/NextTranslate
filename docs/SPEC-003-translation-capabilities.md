# SPEC-003: 翻译能力增强 - Work Engine 功能参考

> 起草日期: 2026-01-09
> 状态: 实施中

## 概述

本文档分析 Work Engine 项目中的翻译功能，识别可作为 NextTranslate 设计参考的能力，并提出功能增强建议。

---

## Work Engine 翻译能力分析

### 1. OCR 识别能力

| 提供商 | 类型 | 特点 |
|--------|------|------|
| OCR.Space | 免费 | 25,000次/月，支持中英文，使用 Engine 2 优化中文识别 |
| 豆包视觉模型 | 付费 | 多模态视觉能力，复杂布局准确率更高 |

**参考价值**: NextTranslate 已具备此能力，可保持现有实现。

---

### 2. AI 翻译模型

#### DeepSeek
- API: `https://api.deepseek.com/v1/chat/completions`
- 模型: `deepseek-chat`
- 特点: 纯文本翻译，需配合 OCR 使用

#### 豆包 (Volcano Engine)
- API: `https://ark.cn-beijing.volces.com/api/v3/chat/completions`
- 特点:
  - 支持图片直接翻译（OCR + 翻译一步完成）
  - 输出格式: 【原文】【译文】结构化解析

**参考价值**: NextTranslate 已具备此能力，可保持现有实现。

---

### 3. 翻译工作流

Work Engine 支持三种翻译工作流:

| 工作流 | 步骤 | 适用场景 |
|--------|------|----------|
| 免费模式 | 截图 → OCR.Space → DeepSeek | 成本敏感用户 |
| 豆包直连 | 截图 → 豆包视觉模型 | 追求准确率 |
| 模块化 | 截图 → OCR → 手动编辑 → 翻译 | 需要人工干预 |

**建议增强**:
- [ ] 增加"模块化工作流"，允许用户在 OCR 后手动编辑文字再翻译

---

### 4. PDF 处理能力

#### 已有能力 (NextTranslate 已具备)
- PyMuPDF 转换 PDF 为图片 (2x 缩放，300+ DPI)
- Base64 编码传输
- pdf2image 作为后备方案

#### 可参考增强
- [ ] **PDF 导出**: 使用 ReportLab 将翻译结果叠加到 PDF 页面
- [ ] **A4 页面适配**: 居中缩放，保持比例

---

### 5. UI 交互模式 (重点参考)

#### 5.1 双栏对比视图
```
┌─────────────────┬─────────────────┐
│    原文 PDF     │   翻译结果      │
│                 │                 │
│   ┌─────────┐   │   ┌─────────┐   │
│   │ 选区1   │   │   │ 译文1   │   │
│   └─────────┘   │   └─────────┘   │
│                 │                 │
└─────────────────┴─────────────────┘
```

**建议增强**:
- [ ] 左右分栏布局，左侧原文，右侧翻译结果
- [ ] 翻译块在右侧对应位置显示

#### 5.2 截图选区功能
- Canvas 画布捕获
- 鼠标拖拽绘制选框
- 最小选区限制 (10x10px)
- 选区可视化反馈

**建议增强**:
- [ ] 选区绘制时显示尺寸提示
- [ ] 支持多个选区批量翻译

#### 5.3 翻译弹窗
```
┌──────────────────────────────────────┐
│ 翻译预览                        [×] │
├──────────────────────────────────────┤
│ ┌─────────────┐  ┌─────────────┐    │
│ │ 截图预览    │  │ OCR 文字    │    │
│ │             │  │ (可编辑)    │    │
│ └─────────────┘  └─────────────┘    │
├──────────────────────────────────────┤
│ 模型: [DeepSeek ▼]  方向: [中→英]   │
├──────────────────────────────────────┤
│ 翻译结果:                            │
│ ┌────────────────────────────────┐  │
│ │ This is the translated text   │  │
│ └────────────────────────────────┘  │
├──────────────────────────────────────┤
│              [保存翻译]              │
└──────────────────────────────────────┘
```

**建议增强**:
- [ ] OCR 文字可编辑，修正识别错误后再翻译
- [ ] 翻译结果预览后再保存

#### 5.4 翻译块叠加显示
- 翻译结果以文字块形式叠加在文档上
- 保留位置坐标信息
- 支持拖拽调整位置

**建议增强**:
- [ ] 翻译块可拖拽重定位
- [ ] 翻译块可编辑文字内容
- [ ] 翻译块可调整字体大小

---

### 6. 页面导航

```
┌─────────────────────────────────────┐
│  [<] [>]  第 3 / 15 页  [跳转: ___] │
└─────────────────────────────────────┘
```

**建议增强**:
- [ ] 上一页/下一页按钮
- [ ] 页码跳转输入框
- [ ] 当前页/总页数显示
- [ ] 键盘快捷键支持 (左右箭头)

---

### 7. 设置面板

Work Engine 使用模态框配置 API Key:

```
┌──────────────────────────────────────┐
│ 设置                            [×] │
├──────────────────────────────────────┤
│ DeepSeek API Key:                    │
│ [sk-************************] [👁]   │
│                                      │
│ 豆包 API Key:                        │
│ [****************************] [👁]  │
│                                      │
│ 豆包 Endpoint ID:                    │
│ [ep-20260101085728-xxxxx]            │
├──────────────────────────────────────┤
│         [测试连接]  [保存]           │
└──────────────────────────────────────┘
```

**建议增强**:
- [ ] API Key 显示/隐藏切换
- [ ] 测试连接按钮验证配置
- [ ] LocalStorage 本地持久化

---

### 8. 状态管理

Work Engine 前端状态结构:

```javascript
translatorState = {
  pages: [],           // 原始 PDF 页面 (base64)
  translatedPages: [], // 翻译后页面
  currentPage: 1,      // 当前页码
  totalPages: 0,       // 总页数
  translations: [],    // 翻译块数组
  currentSelection: null // 当前选区
}

// 翻译块结构
translation = {
  page: 1,           // 所属页码
  x: 100,            // X 坐标
  y: 150,            // Y 坐标
  width: 200,        // 宽度
  height: 50,        // 高度
  text: "译文",      // 翻译文字
  originalText: "",  // 原文 (可选)
  imageData: "..."   // 截图数据
}
```

**建议增强**:
- [ ] 完善状态结构，增加 originalText 字段
- [ ] 翻译历史记录
- [ ] 撤销/重做功能

---

## 功能优先级建议

### P0 - 核心功能 (必须实现)

| 功能 | 描述 | 复杂度 | 状态 |
|------|------|--------|------|
| 双栏布局 | 左原文右译文的对比视图 | 中 | ✅ 已有 |
| 页面导航 | 多页 PDF 切换浏览 | 低 | ✅ 已有 |
| 翻译块显示 | 在右侧对应位置显示翻译 | 中 | ✅ 已有 |

### P1 - 重要功能 (应该实现)

| 功能 | 描述 | 复杂度 | 状态 |
|------|------|--------|------|
| OCR 文字编辑 | 翻译前可修正 OCR 错误 | 低 | ✅ 已有 |
| 翻译块拖拽 | 调整翻译块位置 | 中 | ✅ 已完成 |
| PDF 导出 | 导出带翻译的完整 PDF | 高 | ✅ 已有 |
| 设置面板优化 | API Key 管理界面 | 低 | ✅ 已完成 |

### P2 - 增强功能 (可以实现)

| 功能 | 描述 | 复杂度 | 状态 |
|------|------|--------|------|
| 批量选区 | 一次选多个区域批量翻译 | 高 | 待开发 |
| 翻译块编辑 | 修改已保存的翻译文字 | 低 | ✅ 已完成 |
| 字体调整 | 翻译块字体大小调整 | 低 | 待开发 |
| 键盘快捷键 | 翻页、保存等快捷操作 | 低 | ✅ 已完成 |
| 撤销/重做 | 操作历史管理 | 中 | 待开发 |
| 页码跳转 | 输入页码直接跳转 | 低 | ✅ 已完成 |

---

## API 设计参考

Work Engine 的模块化 API 设计值得借鉴:

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/upload` | POST | 上传 PDF，返回页面图片 |
| `/api/ocr` | POST | 仅 OCR，返回识别文字 |
| `/api/translate` | POST | 仅翻译，返回译文 |
| `/api/doubao-direct` | POST | OCR + 翻译一步完成 |
| `/api/export` | POST | 导出翻译后的 PDF |
| `/api/settings` | GET/POST | 配置管理 |
| `/api/test-api` | POST | 测试 API Key 有效性 |

**建议**: NextTranslate 当前 API 设计已较完善，保持现有结构即可。

---

## 技术实现要点

### PDF 导出 (ReportLab)
```python
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas

def export_translated_pdf(pages, translations):
    # 创建 PDF
    # 遍历页面，绘制原图
    # 在对应位置叠加翻译文字
    # 保存输出
```

### 翻译块拖拽 (前端)
```javascript
// 使用 mousedown/mousemove/mouseup 实现
// 或使用 HTML5 Drag and Drop API
// 更新 translation.x, translation.y
```

### 状态持久化
```javascript
// 使用 LocalStorage 保存:
// - API 配置
// - 用户偏好 (翻译方向、默认模型)
// - 当前会话翻译记录
```

---

## 下一步行动

1. 确认功能优先级
2. 创建具体功能的详细 Spec
3. 按优先级分批实现

---

## 附录: Work Engine 相关代码位置

| 文件 | 行号 | 内容 |
|------|------|------|
| `backend/app.py` | 2960-3598 | 翻译相关后端代码 |
| `frontend/templates/toolbox.html` | 436-3430 | 翻译 UI 和 JS |
| `assets/css/style.css` | 5701-6280 | 翻译界面样式 |
