# SPEC-008: 专业词汇表与智能翻译

> 起草日期: 2026-01-10
> 状态: 草稿

## 概述

增强翻译功能，支持专业词汇对照表、翻译结果叠加覆盖、以及智能 Prompt 模板，使翻译更精准、更符合用户的专业领域需求。

## 功能模块

### 1. 截图翻译叠加覆盖

**需求**: 翻译完当前页后，如果再次使用「截图翻译」，新结果应叠加在已翻译的结果之上，替换重叠区域。

**交互流程**:
```
已翻译的页面
    ↓
点击「截图翻译」
    ↓
在已翻译预览上框选区域
    ↓
AI 翻译选中区域
    ↓
新翻译块替换/覆盖该区域的旧翻译
    ↓
更新预览
```

**实现要点**:
- 框选时检测是否与已有翻译块重叠
- 重叠的旧块自动移除或裁剪
- 新块添加到翻译列表
- 重新生成预览图

**数据结构**:
```javascript
// 每页的翻译数据
translations: {
  1: {
    blocks: [
      { id: 'block_1', bbox: [x0, y0, x1, y1], translated: '...', timestamp: 1234567890 },
      { id: 'block_2', bbox: [x0, y0, x1, y1], translated: '...', timestamp: 1234567891 }
    ]
  }
}
```

---

### 2. 专业词汇对照表

**需求**: 内置词汇表管理，支持本地文件存储和应用内查看编辑。

#### 2.1 存储位置

```
config/
├── config.json          # API 配置
└── glossary.json        # 专业词汇表
```

#### 2.2 词汇表数据结构

```json
{
  "version": 1,
  "updated_at": "2026-01-10T12:00:00Z",
  "glossary": [
    {
      "id": "term_001",
      "source": "machine learning",
      "target": "机器学习",
      "context": "AI/技术领域",
      "note": "不要翻译为'机械学习'"
    },
    {
      "id": "term_002",
      "source": "API",
      "target": "API",
      "context": "技术术语",
      "note": "保持英文原文"
    },
    {
      "id": "term_003",
      "source": "render",
      "target": "渲染",
      "context": "图形/前端",
      "note": ""
    }
  ]
}
```

#### 2.3 界面设计

**入口位置**: 工具栏右侧添加「词汇表」按钮

```
┌─────────────────────────────────────────────────────────────────────┐
│  [打开文件]  [语种: 英→中 ▼]  [翻译当前页] [框选] [导出]  [词汇表]  │
└─────────────────────────────────────────────────────────────────────┘
```

**词汇表弹窗**:
```
┌──────────────────────────────────────────────────────────────┐
│  专业词汇表                                    [打开文件] [×] │
├──────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 搜索词汇...                                    [+ 添加] │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌──────────┬──────────┬──────────┬──────────┬─────┐        │
│  │ 原文     │ 译文     │ 领域     │ 备注     │ 操作│        │
│  ├──────────┼──────────┼──────────┼──────────┼─────┤        │
│  │ machine  │ 机器学习 │ AI/技术  │ 不要译为 │ [编辑]      │
│  │ learning │          │          │ 机械学习 │ [删除]      │
│  ├──────────┼──────────┼──────────┼──────────┼─────┤        │
│  │ API      │ API      │ 技术术语 │ 保持英文 │ [编辑]      │
│  │          │          │          │          │ [删除]      │
│  ├──────────┼──────────┼──────────┼──────────┼─────┤        │
│  │ render   │ 渲染     │ 图形/前端│          │ [编辑]      │
│  │          │          │          │          │ [删除]      │
│  └──────────┴──────────┴──────────┴──────────┴─────┘        │
│                                                              │
│                                    共 3 条  [导入] [导出]    │
└──────────────────────────────────────────────────────────────┘
```

#### 2.4 功能操作

| 操作 | 说明 |
|------|------|
| 添加词条 | 弹出表单，输入原文、译文、领域、备注 |
| 编辑词条 | 行内编辑或弹窗编辑 |
| 删除词条 | 确认后删除 |
| 搜索 | 实时过滤匹配的词条 |
| 打开文件 | 用系统默认编辑器打开 glossary.json |
| 导入 | 从 CSV/JSON 导入词条 |
| 导出 | 导出为 CSV/JSON |

#### 2.5 API 设计

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/glossary` | GET | 获取所有词条 |
| `/api/glossary` | POST | 添加词条 |
| `/api/glossary/<id>` | PUT | 更新词条 |
| `/api/glossary/<id>` | DELETE | 删除词条 |
| `/api/glossary/open-file` | POST | 用系统编辑器打开词汇表文件 |
| `/api/glossary/import` | POST | 导入词条 |
| `/api/glossary/export` | GET | 导出词条 |

---

### 3. 智能翻译 Prompt 模板

**需求**: 翻译时自动注入专业词汇表和用户偏好，提升翻译质量。

#### 3.1 Prompt 模板设计

```
你是一位专业的文档翻译专家。请将以下{source_lang}内容翻译成{target_lang}。

## 翻译要求

1. 保持原文的格式和结构
2. 专业术语按照词汇表翻译
3. 保持语句通顺自然
4. 如遇无法翻译的专有名词，保留原文

## 专业词汇对照表

请严格按照以下词汇表翻译对应术语：

| 原文 | 译文 | 说明 |
|------|------|------|
{glossary_table}

## 用户翻译偏好

{user_preferences}

## 待翻译内容

{content}

## 输出要求

直接输出翻译结果，不要添加任何解释或注释。
```

#### 3.2 词汇表注入

**API 调用前**:
```python
def build_translation_prompt(content, direction, glossary_terms):
    """构建翻译 prompt，注入词汇表"""

    source_lang = "英文" if direction == "en2zh" else "中文"
    target_lang = "中文" if direction == "en2zh" else "英文"

    # 构建词汇表
    glossary_table = ""
    for term in glossary_terms:
        if direction == "en2zh":
            glossary_table += f"| {term['source']} | {term['target']} | {term.get('note', '')} |\n"
        else:
            glossary_table += f"| {term['target']} | {term['source']} | {term.get('note', '')} |\n"

    if not glossary_table:
        glossary_table = "（暂无专业词汇）"

    # 用户偏好
    user_preferences = get_user_preferences()  # 从配置读取

    prompt = TRANSLATION_PROMPT_TEMPLATE.format(
        source_lang=source_lang,
        target_lang=target_lang,
        glossary_table=glossary_table,
        user_preferences=user_preferences,
        content=content
    )

    return prompt
```

#### 3.3 用户偏好配置

**存储在 config.json**:
```json
{
  "deepseek_api_key": "...",
  "doubao_api_key": "...",
  "translation_preferences": {
    "style": "formal",           // formal | casual | technical
    "keep_english_terms": true,  // 保留无法翻译的英文术语
    "use_simplified_chinese": true,
    "custom_rules": [
      "数字使用阿拉伯数字",
      "日期格式保持原样"
    ]
  }
}
```

#### 3.4 偏好设置界面

在「设置」或「词汇表」弹窗中增加「翻译偏好」标签页：

```
┌──────────────────────────────────────────────────────────────┐
│  设置                                                    [×] │
├──────────────────────────────────────────────────────────────┤
│  [词汇表]  [翻译偏好]  [API 配置]                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  翻译风格:                                                   │
│  ○ 正式 (适合学术、商务文档)                                 │
│  ● 技术 (适合技术文档、代码注释)                             │
│  ○ 日常 (适合一般内容)                                       │
│                                                              │
│  ☑ 保留无法翻译的英文术语                                    │
│  ☑ 使用简体中文                                              │
│                                                              │
│  自定义规则:                                                 │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 数字使用阿拉伯数字                                      │ │
│  │ 日期格式保持原样                                        │ │
│  │ 人名音译时附带原文                                      │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                   [+ 添加]   │
│                                                              │
│                                         [取消]  [保存]       │
└──────────────────────────────────────────────────────────────┘
```

---

## 整体界面更新

```
┌─────────────────────────────────────────────────────────────────────────┐
│  [打开文件]  [语种: 英→中 ▼]  [翻译当前页] [框选翻译] [导出]  [词汇表] [设置] │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────┐      ┌─────────────────────────┐          │
│  │                         │      │                         │          │
│  │      原始 PDF           │      │      翻译结果           │          │
│  │      (当前页图片)       │      │      (翻译后预览)       │          │
│  │                         │      │                         │          │
│  └─────────────────────────┘      └─────────────────────────┘          │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│  ◀  [1] / 10  ▶                              [━━━━●━━━━━━━━]           │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## API 设计汇总

### 词汇表 API

| 端点 | 方法 | 请求体 | 响应 |
|------|------|--------|------|
| `/api/glossary` | GET | - | `{ success, glossary: [...] }` |
| `/api/glossary` | POST | `{ source, target, context, note }` | `{ success, term: {...} }` |
| `/api/glossary/<id>` | PUT | `{ source, target, context, note }` | `{ success }` |
| `/api/glossary/<id>` | DELETE | - | `{ success }` |
| `/api/glossary/open-file` | POST | - | `{ success }` |

### 偏好设置 API

| 端点 | 方法 | 请求体 | 响应 |
|------|------|--------|------|
| `/api/preferences` | GET | - | `{ success, preferences: {...} }` |
| `/api/preferences` | POST | `{ style, keep_english_terms, custom_rules }` | `{ success }` |

---

## 实现步骤

### Phase 1: 词汇表基础功能
- [ ] 创建 glossary.json 数据文件
- [ ] 实现词汇表 CRUD API
- [ ] 添加词汇表弹窗界面
- [ ] 实现「打开文件」功能

### Phase 2: Prompt 模板集成
- [ ] 设计 Prompt 模板
- [ ] 翻译 API 调用时注入词汇表
- [ ] 实现用户偏好存储

### Phase 3: 截图翻译叠加
- [ ] 实现翻译块重叠检测
- [ ] 实现覆盖/替换逻辑
- [ ] 更新预览生成逻辑

### Phase 4: 偏好设置界面
- [ ] 添加设置弹窗
- [ ] 翻译偏好配置界面
- [ ] 自定义规则管理

---

## 验收标准

1. 能添加、编辑、删除专业词汇
2. 能用系统编辑器打开 glossary.json 文件
3. 翻译时词汇表术语正确替换
4. 截图翻译能覆盖已有翻译块
5. 用户偏好设置生效
6. 导出的 PDF 包含所有翻译（包括叠加的）

---

## Prompt 模板示例（完整版）

```
你是一位专业的文档翻译专家。请将以下英文内容翻译成中文。

## 翻译要求

1. 保持原文的格式和结构
2. 专业术语按照词汇表翻译
3. 保持语句通顺自然
4. 如遇无法翻译的专有名词，保留原文

## 专业词汇对照表

请严格按照以下词汇表翻译对应术语：

| 原文 | 译文 | 说明 |
|------|------|------|
| machine learning | 机器学习 | 不要译为"机械学习" |
| API | API | 保持英文原文 |
| render | 渲染 | |
| component | 组件 | 前端术语 |

## 用户翻译偏好

- 翻译风格：技术文档
- 保留无法翻译的英文术语
- 使用简体中文
- 数字使用阿拉伯数字
- 日期格式保持原样

## 待翻译内容

The machine learning API provides a simple interface to render components.

## 输出要求

直接输出翻译结果，不要添加任何解释或注释。
```

**期望输出**:
```
机器学习 API 提供了一个简单的接口来渲染组件。
```
